---
- name: Ensure prerequisites are present (docker, curl)
  block:
    - name: Install Docker (primary)
      ansible.builtin.dnf:
        name: docker
        state: present
      register: docker_install
      ignore_errors: true

    - name: Fallback - install moby-engine if docker not available
      ansible.builtin.dnf:
        name: moby-engine
        state: present
      when: docker_install is failed

    - name: Install curl
      ansible.builtin.dnf:
        name: curl
        state: present

- name: Enable and start Docker service
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: yes

- name: Add {{ kind_kubeconfig_user }} to docker group
  ansible.builtin.user:
    name: "{{ kind_kubeconfig_user }}"
    groups: docker
    append: yes
  failed_when: false

- name: Detect target architecture for downloads
  ansible.builtin.set_fact:
    kind_arch: "{{ 'amd64' if ansible_facts.architecture in ['x86_64', 'amd64'] else 'arm64' if ansible_facts.architecture in ['aarch64', 'arm64'] else ansible_facts.architecture }}"

- name: Install kubectl
  block:
    - name: Download kubectl
      ansible.builtin.get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/{{ kind_arch }}/kubectl"
        dest: /usr/local/bin/kubectl
        mode: "0755"

    - name: Verify kubectl version
      ansible.builtin.command:
        cmd: /usr/local/bin/kubectl version --client=true --output=yaml
      register: kubectl_ver
      changed_when: false

- name: Install kind
  block:
    - name: Download kind
      ansible.builtin.get_url:
        url: "https://github.com/kubernetes-sigs/kind/releases/download/{{ kind_version }}/kind-linux-{{ kind_arch }}"
        dest: /usr/local/bin/kind
        mode: "0755"

    - name: Verify kind version
      ansible.builtin.command:
        cmd: /usr/local/bin/kind --version
      register: kind_ver
      changed_when: false

- name: Check existing kind clusters
  ansible.builtin.command:
    cmd: /usr/local/bin/kind get clusters
  register: kind_clusters
  changed_when: false
  failed_when: false

- name: Create kind cluster (if missing)
  ansible.builtin.command:
    cmd: >-
      /usr/local/bin/kind create cluster
      --name {{ kind_cluster_name }}
      --image {{ kind_node_image }}
      --wait {{ kind_wait }}
  when: kind_cluster_name not in (kind_clusters.stdout_lines | default([]))
  register: kind_create
  changed_when: true

- name: Ensure kubeconfig directory exists for {{ kind_kubeconfig_user }}
  ansible.builtin.file:
    path: "/home/{{ kind_kubeconfig_user }}/.kube"
    state: directory
    owner: "{{ kind_kubeconfig_user }}"
    group: "{{ kind_kubeconfig_user }}"
    mode: "0700"

- name: Copy kubeconfig to {{ kind_kubeconfig_user }}
  ansible.builtin.copy:
    src: /root/.kube/config
    dest: "{{ kind_kubeconfig_path }}"
    owner: "{{ kind_kubeconfig_user }}"
    group: "{{ kind_kubeconfig_user }}"
    mode: "0600"
    remote_src: true

- name: Verify cluster access as {{ kind_kubeconfig_user }}
  ansible.builtin.command:
    cmd: /usr/local/bin/kubectl get nodes
  become_user: "{{ kind_kubeconfig_user }}"
  environment:
    KUBECONFIG: "{{ kind_kubeconfig_path }}"
  register: kubectl_nodes
  changed_when: false

- name: Show nodes
  ansible.builtin.debug:
    var: kubectl_nodes.stdout
