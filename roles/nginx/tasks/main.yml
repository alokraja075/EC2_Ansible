---
# Tasks to install and configure Nginx web server

- name: Update all packages
  dnf:
    name: '*'
    state: latest
  become: yes

- name: Install Nginx and required packages
  dnf:
    name:
      - nginx
      - curl-minimal
      - git
    state: present
  become: yes

- name: Create web root directory
  file:
    path: /var/www/html
    state: directory
    owner: nginx
    group: nginx
    mode: '0755'
  become: yes

- name: Create index.html
  copy:
    content: |
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Welcome to Nginx</title>
          <style>
              body {
                  font-family: Arial, sans-serif;
                  margin: 0;
                  padding: 20px;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  min-height: 100vh;
                  display: flex;
                  justify-content: center;
                  align-items: center;
              }
              .container {
                  background: white;
                  padding: 40px;
                  border-radius: 10px;
                  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                  text-align: center;
                  max-width: 500px;
              }
              h1 {
                  color: #333;
                  margin: 0 0 20px 0;
              }
              p {
                  color: #666;
                  line-height: 1.6;
              }
              .info {
                  background: #f5f5f5;
                  padding: 15px;
                  border-radius: 5px;
                  margin: 20px 0;
              }
              .success {
                  color: #27ae60;
                  font-weight: bold;
              }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>âœ“ Nginx is Running!</h1>
              <p>Your Nginx web server has been successfully installed and configured.</p>
              <div class="info">
                  <p><strong>Server Status:</strong> <span class="success">Active</span></p>
                  <p><strong>Document Root:</strong> /var/www/html</p>
              </div>
              <p>Edit /var/www/html/index.html to customize this page.</p>
          </div>
      </body>
      </html>
    dest: /var/www/html/index.html
    owner: nginx
    group: nginx
    mode: '0644'
  become: yes

- name: Start and enable Nginx service
  systemd:
    name: nginx
    state: started
    enabled: yes
  become: yes

- name: Configure Nginx to use /var/www/html
  copy:
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          
          server_name _;
          
          root /var/www/html;
          index index.html index.htm index.nginx-debian.html;
          
          location / {
              try_files $uri $uri/ =404;
          }
      }
    dest: /etc/nginx/conf.d/default.conf
    owner: root
    group: root
    mode: '0644'
  become: yes

- name: Remove default server config
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  become: yes
  ignore_errors: yes

- name: Restart Nginx to apply config
  systemd:
    name: nginx
    state: restarted
  become: yes

- name: Display access information
  debug:
    msg:
      - "========================================"
      - "Nginx Installation Complete!"
      - "========================================"
      - "Access URL: http://{{ ansible_host }}"
      - "Web Root: /var/www/html"
      - "Config: /etc/nginx/nginx.conf"
      - "========================================"
